<!DOCTYPE html>
<html lang="en-US">
    <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css">
    <title>2048 Duel</title>
    <style>
        * {
        padding: 0;
        margin: 10;
        }
        canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
        }
    </style>
    </head>
    <body>
        <h1 id="title_field">2048 Duel!</h1>
        <canvas id="myCanvas" width="615" height="775" padding="20px"></canvas>
        <p>How to play: normal 2048, but duel</p>
        <!-- <p id="debug1"></p>
        <p id="debug2"></p> -->
        <!-- <button onclick="updateBoard()">Get Board</button> -->
        <!-- <p id="request_status"></p> -->
        <!-- <textarea id="board_printer" rows="10" cols="40"></textarea> -->

        
        <script>
            // document.write("hello world")
            // ----------------------- Settings and Setup -----------------------
            var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");
            
            var size = 150

            // fonts
            block_font = "75px Standard";
            block_font2 = "75px Palatino";

            score_font = "30px Palatino";
            turn_font = "50px Palatino";


            // colors
            var green = "121, 130, 101";
            var salmon = "203, 141, 126";
            var navy = "33, 51, 67";
            var yellow = "231,185,28"
            
            var black = "67,67,67";
            var grey = "147,152,157";
            var white = "250,250,250";
            var cream = "250,249,243";

            // settings for player 1 and 2 colors
            var p1color = green;
            var p2color = salmon;

            var rightPressed = false;
            var leftPressed = false;
            var upPressed = false;
            var downPressed = false;

            // board information
            board_info = null;
            var keypress_active = false;
            var update_needed = false;
            var move_type = null;
            var endgame = false;

            // holds the http request object
            var xhr = null;

            // ------------------------------------------------------------------

            // --------------------- Listeners and Handlers ---------------------
            document.addEventListener("keydown", keyDownHandler, false);
            document.addEventListener("keyup", keyUpHandler, false);

            function keyDownHandler(e) {
                // prevent arrow keys from scrolling
                if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                    e.preventDefault();
                }   

                if(e.key == "Right" || e.key == "ArrowRight") {
                    rightPressed = true;
                    move_type = "right";
                }
                else if(e.key == "Left" || e.key == "ArrowLeft") {
                    leftPressed = true;
                    move_type = "left";
                }
                else if (e.key == "Up" || e.key == "ArrowUp"){
                    upPressed = true;
                    move_type = "up";
                }
                else if (e.key == "Down" || e.key == "ArrowDown"){
                    downPressed = true;
                    move_type = "down";
                }

                // set keypress active variable
                if (rightPressed || leftPressed || upPressed || downPressed){
                    if (!keypress_active){
                        keypress_active = true;
                        update_needed = true;
                    }
                }
            }

            function keyUpHandler(e) {
                if(e.key == "Right" || e.key == "ArrowRight") {
                    rightPressed = false;
                }
                else if(e.key == "Left" || e.key == "ArrowLeft") {
                    leftPressed = false;
                }
                else if (e.key == "Up" || e.key == "ArrowUp"){
                    upPressed = false;
                }
                else if (e.key == "Down" || e.key == "ArrowDown"){
                    downPressed = false;
                }

                if (!rightPressed && !leftPressed && !upPressed && !downPressed){
                    if (keypress_active){
                        keypress_active = false;
                    }
                }
            }
            // ------------------------------------------------------------------
            
            // ------------------------ Backend Requests ------------------------
            // build the http request object
            getXmlHttpRequestObject = function () {
                if (!xhr) {
                    // Create a new XMLHttpRequest object 
                    xhr = new XMLHttpRequest();
                }
                return xhr;
            };

            // function to control getBoard response behavior
            function boardCallback() {
                // Check response is ready or not
                if (xhr.readyState == 4 && xhr.status == 200) {
                    console.log("User data received!");
                    
                    // Update board_info with new text
                    board_info = JSON.parse(xhr.responseText);

                    // debugging
                    // dataDiv = document.getElementById('board_printer');
                    // dataDiv.innerHTML = xhr.responseText;
                    console.log(xhr.responseText);

                    // check for endgame
                    if (board_info["state"] != "CONTINUE" && board_info["state"] != "NO_CHANGE"){
                        console.log("endgame reached");
                        endgame = true;
                    }

                    // update the screen
                    drawBoard(board_info);
                }
            }

            // Gets updated board information and updates the screen
            function updateBoard() {
                console.log("Getting board...");
                xhr = getXmlHttpRequestObject();
                xhr.onreadystatechange = boardCallback;

                // asynchronous requests
                xhr.open("GET", "http://localhost:6969/board", true);

                // Send the request over the network
                xhr.send(null);
            }

            function makeMove(direction){
                xhr = getXmlHttpRequestObject();
                xhr.onreadystatechange = boardCallback;

                // asynchronous requests
                // todo: make synchronous to clean up logic
                xhr.open("POST", "http://localhost:6969/move", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify({"move" : direction});
                
                // Send the request over the network
                xhr.send(data);
            }

            // ------------------------------------------------------------------


            // draw the grid
            function drawBoard(board_info){
                // grab the updated board
                // clear the grid
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (!board_info){
                    console.log("error: no board information received");
                }
                for (var row = 0; row < 4; ++row){
                    for (var col = 0; col < 4; ++col){
                        ctx.beginPath();

                        text = "0";
                        owner = null;
                        player = -1;

                        // parse the current number
                        if (board_info != null){
                            console.log("board information recieved in drawGrid()")
                            text = board_info["board"][col][row].toString();                            
                            
                            // set the owner
                            if (text != 0){
                                if (board_info["owner"][col][row] == 0){
                                    player = 1;
                                }
                                else {
                                    player = 2;
                                }
                            }
                        }
                        
                        // draw the rectangle backgrounds
                        ctx.rect(size * row + .1 * size, size * col + .1 * size, .9 * size, .9 * size);
                        if (player == 1){
                            ctx.fillStyle = "rgb(" + p1color + ", 0.5)";
                        }
                        else if (player == 2){
                            ctx.fillStyle = "rgb(" + p2color + ", 0.5)";
                        }
                        else{
                            ctx.fillStyle = "rgb(" + grey + ", 0.25)";
                        }
                        ctx.fill();
                        
                        // draw the numbers
                        ctx.font = block_font2;
                        ctx.textAlign = "center";
                        if (text != "0"){
                            ctx.fillStyle = "rgba(" + white + ", .9)";
                            ctx.fillText(text, size * row + .55 * size, size * col + .675 * size);
                        }
                        
                        ctx.closePath();
                    }
                }

                // write the scores
                ctx.beginPath();
                ctx.rect(.1 * size, 4 * size + .1 * size, 3.9 * size, size);
                ctx.fillStyle = "rgb(" + grey + ", 0.25)"
                ctx.fill();

                ctx.font = score_font;
                ctx.textAlign = "left";
                ctx.fillStyle = "rgba(" + p1color + ", .8)";
                text = "Player 1 score: " + board_info["p1score"];
                ctx.fillText(text, .2 * size, 4 * size + .4 * size);

                ctx.textAlign = "right";
                ctx.fillStyle = "rgba(" + p2color + ", .8)";
                text = "Player 2 score: " + board_info["p2score"];
                ctx.fillText(text, canvas.width - .2 * size, 4 * size + .4 * size);
                
                // write the turn
                ctx.textAlign = "center";
                ctx.font = turn_font;

                // tie
                if (board_info["state"] == "LOSS"){
                    ctx.fillStyle = "rgba(" + grey + ", .8)";
                    text = "It's a tie!";
                }
                // win
                else if (board_info["state"] == "WIN1"){
                    console.log("player 1 won!");
                    ctx.fillStyle = "rgba(" + p1color + ", .8)";
                    text = "Player 1 wins!";
                }
                else if (board_info["state"] == "WIN2"){
                    ctx.fillStyle = "rgba(" + p2color + ", .8)";
                    text = "Player 2 wins!";
                }

                // normal
                else{
                    if (board_info["turn"] == 1){
                        ctx.fillStyle = "rgba(" + p1color + ", .8)";
                        text = "Player 1's turn";
                    }
                    else{
                        ctx.fillStyle = "rgba(" + p2color + ", .8)";
                        text = "Player 2's turn";
                    }
                }
                ctx.fillText(text, canvas.width / 2, 4 * size + .9 * size);

                
                ctx.closePath();
            }

            function mainLoop(){
                if (endgame){
                    return;
                }

                // process keypress
                if (update_needed){
                    console.log("making move " + move_type);
                    makeMove(move_type);
                    update_needed = false;
                }

                // debugging
                // document.getElementById("debug1").innerHTML = "up: " + upPressed + ", down: " + downPressed;
                // document.getElementById("debug2").innerHTML = "left: " + leftPressed + ", right: " + rightPressed;
            }
            
            updateBoard();
            setInterval(mainLoop, 10);
        </script>
    </body>
</html>
